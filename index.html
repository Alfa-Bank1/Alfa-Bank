<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = tg.initDataUnsafe.user;
    const userId = user ? user.id.toString() : null; // Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    let enteredPassword = [];
    let tempPassword = [];
    const passwordDots = document.querySelectorAll('.password-dot');
    const errorMessage = document.getElementById('error-message');
    const keyboard = document.getElementById('keyboard');
    const passwordTitle = document.getElementById('password-title');
    const mainContent = document.getElementById('main-content');
    const backgroundImage = document.getElementById('background-image');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    function initKeyboard() {
        keyboard.innerHTML = '';
        const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        
        numbers.forEach(num => {
            const button = createButton(num);
            keyboard.appendChild(button);
        });

        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        const zeroBtn = createButton(0);
        const backspaceBtn = createButton('‚å´', 'backspace-btn', handleBackspace);
        const bioBtn = createButton('üß¨', 'biometric-btn', handleBiometric);

        keyboard.appendChild(zeroBtn);
        keyboard.appendChild(backspaceBtn);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–æ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        checkStoredPassword();
    }

    function createButton(content, className = '', onClick = null) {
        const button = document.createElement('button');
        button.textContent = content;
        if (className) button.classList.add(className);
        
        if (typeof content === 'number') {
            button.dataset.number = content;
            button.addEventListener('click', handleNumberClick);
        }
        
        if (onClick) button.addEventListener('click', onClick);
        
        return button;
    }

    async function handleNumberClick(e) {
        if (enteredPassword.length < 4) {
            const number = e.target.dataset.number;
            enteredPassword.push(number);
            updatePasswordDots();
            
            if (enteredPassword.length === 4) {
                if (!tempPassword.length) {
                    // –ü–µ—Ä–≤—ã–π –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è
                    tempPassword = [...enteredPassword];
                    passwordTitle.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                    clearPassword();
                } else {
                    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
                    if (enteredPassword.join('') === tempPassword.join('')) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                        const response = await savePassword(tempPassword.join(''));
                        if (response.success) {
                            showModal('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                            passwordTitle.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                            initKeyboard(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                        } else {
                            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
                        }
                    } else {
                        showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                        clearPassword();
                        tempPassword = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
                        passwordTitle.textContent = '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å';
                    }
                }
            }
        }
    }

    async function checkStoredPassword() {
        const response = await fetch('/check-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId }),
        });
        const data = await response.json();
        if (data.success) {
            passwordTitle.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
        } else {
            passwordTitle.textContent = '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å';
        }
    }

    async function savePassword(password) {
        const response = await fetch('/save-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, password }),
        });
        return response.json();
    }

    async function checkPassword() {
        const response = await fetch('/check-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, password: enteredPassword.join('') }),
        });
        const data = await response.json();
        if (data.success) {
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            mainContent.style.display = 'none';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            backgroundImage.style.display = 'block';
        } else {
            showError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
            clearPassword();
        }
    }

    function handleBackspace() {
        if (enteredPassword.length > 0) {
            enteredPassword.pop();
            updatePasswordDots();
        }
    }

    function handleBiometric() {
        alert('–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    }

    function updatePasswordDots() {
        passwordDots.forEach((dot, index) => {
            if (enteredPassword.length > index) {
                dot.classList.add('filled');
            } else {
                dot.classList.remove('filled');
            }
        });
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        if (navigator.vibrate) navigator.vibrate(200);
        setTimeout(() => errorMessage.style.display = 'none', 1500);
    }

    function clearPassword() {
        enteredPassword = [];
        updatePasswordDots();
    }

    function showModal(message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.textContent = message;
        document.body.appendChild(modal);
        setTimeout(() => modal.remove(), 2000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
        if (!userId) {
            showError('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.');
            return;
        }
        initKeyboard();
        setTimeout(() => {
            document.getElementById('splash-screen').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –∑–∞—Å—Ç–∞–≤–∫—É
            document.getElementById('main-content').style.display = 'flex'; // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã
    });
</script>